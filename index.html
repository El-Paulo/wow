<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WOW Demos ‚Äì FIX v7 (C√°mara primero + fallback libs)</title>
<style>
  body{margin:0;background:#0b1117;color:#e6edf3;font:500 15px system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin-bottom:12px}
  button,select{background:#0d1a29;color:#e6edf3;border:1px solid rgba(255,255,255,.14);padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#4cc9f0}
  #stage{position:relative;min-height:460px;background:#0a131e;border-radius:14px;border:1px solid rgba(255,255,255,.08);overflow:hidden}
  #video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);opacity:.85}
  canvas{position:absolute;inset:0;transform:scaleX(-1)}
  #log{font:12px ui-monospace,Menlo,Consolas,monospace;background:#0c1622;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px;max-height:200px;overflow:auto}
  .ok{color:#22c55e}.err{color:#ef4444}.warn{color:#eab308}
  /* Modal */
  #modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999}
  #modal .box{background:#101a28;border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:20px;max-width:520px;width:min(92%,520px)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <select id="demo">
      <option value="hands">üéµ Therem√≠n con la mano</option>
      <option value="face">üòé FaceMesh AR</option>
      <option value="pose">üßç Pose ‚Üí cubo 3D</option>
    </select>
    <select id="cameraSel"></select>
    <button id="start">Iniciar c√°mara</button>
    <button id="stop" disabled>Detener</button>
    <button id="audio" disabled>üîà Activar audio</button>
  </div>
  <div id="stage" class="card">
    <video id="video" playsinline muted></video>
    <canvas id="overlay"></canvas>
    <div id="three-root" style="position:absolute;inset:0"></div>
  </div>
  <div class="card">
    <div style="margin-bottom:8px; font-size:13px; opacity:.8">Pasos: 1) HTTPS/localhost ¬∑ 2) Iniciar c√°mara (permitir) ¬∑ 3) Activar audio ¬∑ 4) Elegir demo.</div>
    <button id="runTests">Ejecutar pruebas</button>
    <button id="clearLog">Limpiar</button>
    <div id="log"></div>
  </div>
</div>
<div id="modal"><div class="box">
  <h2>Permiso de c√°mara requerido</h2>
  <p id="modalReason">Debes otorgar acceso a la c√°mara o abrir por HTTPS.</p>
  <button id="modalRetry">üîÅ Probar de nuevo</button>
  <button id="modalClose">Cerrar</button>
</div></div>

<!-- tfjs base (no bloquea la c√°mara) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.19.0/dist/tf.min.js"></script>
<script>
// ===== util de carga sin fallar la c√°mara =====
function loadScript(src){return new Promise(function(res,rej){var s=document.createElement('script');s.src=src;s.async=true;s.crossOrigin='anonymous';s.onload=res;s.onerror=rej;document.head.appendChild(s);});}
function isSecure(){return location.protocol==='https:'||location.hostname==='localhost'||location.hostname==='127.0.0.1'}
function $(s){return document.querySelector(s)}
function log(m){var el=$('#log'); el.innerHTML+=m+'<br>'; el.scrollTop=el.scrollHeight}
function camMsg(e){if(!e) return 'Error desconocido'; var n=e.name||''; if(n==='SecurityError') return 'Usa HTTPS o http://localhost'; if(n==='NotAllowedError') return 'Permiso denegado'; if(n==='NotFoundError') return 'No hay c√°mara'; if(n==='NotReadableError') return 'C√°mara ocupada por otra app'; if(n==='OverconstrainedError') return 'Restricciones no cumplidas'; return (n? n+': ':'')+(e.message||e)}

// ===== elementos =====
var video=$('#video'), canvas=$('#overlay'), ctx=canvas.getContext('2d');
var startBtn=$('#start'), stopBtn=$('#stop'), audioBtn=$('#audio');
var demoSel=$('#demo'), camSel=$('#cameraSel');
var modal=$('#modal'), modalRetry=$('#modalRetry'), modalClose=$('#modalClose');

// ===== c√°mara primero =====
async function start(){
  if(!isSecure()){ modal.style.display='flex'; return; }
  try{
    // No bloqueamos por libs: pedimos c√°mara primero
    var deviceId = camSel.value || undefined;
    var constraints = { video: deviceId? {deviceId:{exact:deviceId}} : { facingMode:'user', width:{ideal:1280}, height:{ideal:720} }, audio:false };
    var stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream; await video.play();
    await populateCams();
    stopBtn.disabled=false; startBtn.disabled=true; audioBtn.disabled=false;
    // Cargar modelos en background (sin romper la sesi√≥n de c√°mara)
    warmupModels();
  }catch(e){
    log('<span class="err">‚úñ</span> C√°mara: '+camMsg(e));
    if(e.name==='NotAllowedError'||e.name==='SecurityError'){ modal.style.display='flex'; } else { alert('No se pudo iniciar la c√°mara: '+camMsg(e)); }
  }
}
function stop(){ try{ cancelAnimationFrame(window._rafId); }catch(_){}
  if(video.srcObject){ var t=video.srcObject.getTracks(); for(var i=0;i<t.length;i++){ t[i].stop(); } video.srcObject=null; }
  stopBtn.disabled=true; startBtn.disabled=false; audioBtn.disabled=true; ctx.clearRect(0,0,canvas.width,canvas.height);
}
async function populateCams(){ if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices) return; var devs=await navigator.mediaDevices.enumerateDevices(); var cams=devs.filter(function(d){return d.kind==='videoinput'}); camSel.innerHTML=''; for(var i=0;i<cams.length;i++){ var o=document.createElement('option'); o.value=cams[i].deviceId; o.textContent=cams[i].label||('C√°mara '+(i+1)); camSel.appendChild(o);} }

// ===== modelos: carga tolerante =====
async function warmupModels(){
  // intentamos hpd ‚Üí si falla, mp tasks ‚Üí si falla, seguimos solo con video
  try{ if(!window.handPoseDetection){ try{ await loadScript('https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection@2.0.2/dist/hand-pose-detection.min.js'); } catch(_){ await loadScript('https://unpkg.com/@tensorflow-models/hand-pose-detection@2.0.2/dist/hand-pose-detection.min.js'); } }
       log((window.handPoseDetection?'‚úî':'‚úñ')+' handPoseDetection'); }catch(_){ log('‚úñ handPoseDetection'); }
  try{ if(!window.poseDetection){ await loadScript('https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@3.4.0/dist/pose-detection.min.js'); } log((window.poseDetection?'‚úî':'‚úñ')+' poseDetection'); }catch(_){ log('‚úñ poseDetection'); }
  try{ if(!window.faceLandmarksDetection){ await loadScript('https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.4/dist/face-landmarks-detection.min.js'); } log((window.faceLandmarksDetection?'‚úî':'‚úñ')+' faceLandmarksDetection'); }catch(_){ log('‚úñ faceLandmarksDetection'); }
  try{ if(!window.THREE){ await loadScript('https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js'); await loadScript('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js'); } }catch(_){}
  try{ if(!window.Tone){ await loadScript('https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js'); } }catch(_){}
}

// ===== pruebas =====
$('#runTests').onclick=function(){
  var lines=[]; lines.push((window.isSecureContext?'‚úî':'‚úñ')+' contexto seguro');
  lines.push((navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?'‚úî':'‚úñ')+' getUserMedia');
  lines.push((!!window.handPoseDetection?'‚úî':'‚úñ')+' handPoseDetection');
  lines.push((!!window.poseDetection?'‚úî':'‚úñ')+' poseDetection');
  lines.push((!!window.faceLandmarksDetection?'‚úî':'‚úñ')+' faceLandmarksDetection');
  $('#log').innerHTML=lines.join('<br>');
};
$('#clearLog').onclick=function(){ $('#log').innerHTML=''; };

// ===== audio =====
audioBtn.onclick=function(){ Tone.start().then(function(){ window._gain=new Tone.Gain(0.0).toDestination(); window._synth=new Tone.Synth().connect(window._gain); audioBtn.disabled=true; }).catch(function(e){ log('<span class="err">‚úñ</span> Audio: '+e); }); };

// ===== listeners =====
startBtn.onclick=start; stopBtn.onclick=stop; modalRetry.onclick=function(){ modal.style.display='none'; start(); }; modalClose.onclick=function(){ modal.style.display='none'; };

// ===== init =====
if(!isSecure()){ log('<span class="warn">‚ö†</span> Abre por HTTPS o localhost para usar la c√°mara'); }
</script>
</body>
</html>
